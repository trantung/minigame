SpilGames("spilgames.import",{name:"EventTracker",deps:"TrackerData Tracker LocalStorage Utils JSLib Portal RefTag FeatureDetector".split(" "),module:function(){return function(g,k,m,e,f,p,h,n){if(window.trackerInstance)return f("spilgames.debug.%s.eventTracker".replace("%s","info"),"reuse instance var"),window.trackerInstance;var b=this,c,a=f.ns+".module.tracker.event.",q="eventCategory eventAction eventLabel eventValue timing properties".split(" "),x={"interval.communicate":10,"interval.heartbeat":120,
"net.sendFormat":"autoselect","net.sendMethod":"post","net.dataFormat":"object"},r=0,u=[],v,t=!1,l=e.getNavigationStartTime(),d={},y=function(w){c?g.getSessionId(function(a){m.getItem({key:"TRACKER.event."+a},function(a){w(e.isArray(a)?a:[])})}):w(u)},I=function(w,a){c?g.getSessionId(function(b){m.setItem({key:"TRACKER.event."+b,value:w,expires:1E3},function(b){c=b;e.isFunction(a)&&a(w)})}):(u=w,e.isFunction(a)&&a(u))},J=function(){c&&g.getSessionId(function(a){m.removeItem("TRACKER.event."+a)});
u=[]},K=function(a,b){y(function(d){d.push(a);I(d);b(d)})},z=function(a,d,l){l=l||e.emptyFn;!1===("object"===typeof d&&Object(d)===d)&&(d={sendFormat:b.settings.get("net.sendFormat"),sendMethod:b.settings.get("net.sendMethod"),dataFormat:b.settings.get("net.dataFormat")});e.isArray(a)||(a=[a]);k.send({settings:d,request:{eventList:a}},l)},L=function(a,d){var b;return{start:function(){b=window.setInterval(d,a)},stop:function(){window.clearInterval(b)}}},A=function(a,b,l){d[a]=L(1E3*b,l);return d[a]},
B=function(){for(var a in d)d[a]&&d[a].stop();l=0},C=function(a){a=a||e.emptyFn;!0===f.get("tracker.event.disable")&&B();y(function(b){a(b);f("spilgames.debug.%s.eventTracker".replace("%s","debug"),{msg:"communicate queue: ",data:b});0<b.length&&(z(b),J())})},M=function(){l||(l=+new Date);A("communicate",b.settings.get("interval.communicate"),C);A("heartbeat",b.settings.get("interval.heartbeat"),function(){var a={pageType:p.get("pagetype"),pageTypeDetail:p.get("pagetypedetail"),pageId:p.get("pageid")};
z({eventCategory:"heartbeat",eventAction:"ping",timing:parseInt(+new Date-l,10),properties:a})});d.communicate.start();d.heartbeat.start()},D=function(a){var b,d=!0;if(!0===e.isArray(a))return e.each(a,function(a){!1===D(a)&&(d=!1)}),d;if(!1===("object"===typeof a&&Object(a)===a))return!1;for(b in a)if(e.has(a,b)&&!1===e.contains(q,b)){d=!1;break}return d},E=function(a,b){g.getPageInSession(function(d){e.each(a,function(a){a.timing=parseInt(+new Date-l,10);a.pageInSession=d});b(a)})},F=function(a,
b){var d={callback:a.callback||b||e.emptyFn,settings:a.settings||void 0,data:a.data||a};if(!1===D(d.data))f("spilgames.debug.%s.eventTracker".replace("%s","debug"),"trackExpress() data argument was invalidated"),d.callback(!1);else return!1===e.isArray(d.data)&&(d.data=[d.data]),d},G=function(a){!1===t&&0===r?g.incrementPageInSession(function(b){t=!0;a()}):a()},H=function(a){a=a||e.emptyFn;h.getReferrerTag(function(b){var d=g.getPageInfo();d.referrerTag=b;k.send({settings:{sendFormat:"gif",sendMethod:"get",
dataFormat:"string"},request:d},a)})};b.settings={values:x,get:function(a){a=x[a];return void 0!==a?a:null},set:function(a,b){v||(x[a]=b)}};b.sendPageview=function(a){a=a||e.emptyFn;f("spilgames.debug.%s.eventTracker".replace("%s","debug"),"sendPageview, pageviewSequence: "+r+", internalPageview?:"+t);r+=1;1===r&&!0===t?H(a):g.incrementPageInSession(function(b){H(a)})};window.trackerInstance={setTracker:function(a){k=a},init:function(){if(v)return!1;h.init();c=n.localStorage()?!0:!1;e.each(b.settings.values,
function(d,l){var q=f.get(a+l);null!==q&&b.settings.set(l,q)});M();v=!0},stop:function(){B();d={};t=v=!1;r=0},track:function(a,b){var d=F(a,b);d&&G(function(){E(d.data,function(a){e.each(a,function(a){K(a,function(b){f("spilgames.debug.%s.eventTracker".replace("%s","info"),{msg:"Queued localStorage "+(c?"supported":"unsupported"),added:a,queue:b})})})});y(function(a){d.callback(a)})})},trackExpress:function(a,b){var d=F(a,b);d&&G(function(){E(d.data,function(a){z(a,d.settings,d.callback)})})},sendPageview:b.sendPageview,
settings:b.settings,flushQueue:C};f("spilgames.debug.%s.eventTracker".replace("%s","info"),"instance created");return window.trackerInstance}}()});SpilGames("spilgames.module.import.loadmodule",{name:"Heatmap",deps:["JSLib"],module:function(g){function k(b,c,a){if(b&&c&&a){if(!f&&0<e.width&&0<e.height){f=!0;var q=h.init;h.track===q&&p.push(void 0);g(q,void 0);0<e.width&&0<e.height&&k("browser","viewportSize",e.width+"x"+e.height)}f&&(q=h.track,b={eventCategory:b,eventAction:c,eventLabel:a},h.track===q&&p.push(b),g(q,b))}}var m={left:0,top:0},e={width:0,height:0},f=!1,p=[],h={init:"tracker.event.init",track:"tracker.event.track"},n=Math.round;
return{trackClick:function(b){if(b&&b.hasOwnProperty("x")&&b.hasOwnProperty("y")){var c;c=n(b.x+document.body.scrollLeft+document.documentElement.scrollLeft-m.left);b=n(b.y+document.body.scrollTop+document.documentElement.scrollTop-m.top);c=[c,b].join();k("interaction","click",c)}},setOffset:function(b){m.left=n(b.left)||0;m.top=n(b.top)||0},getOffset:function(){return m},setViewport:function(b){e.width=n(b.width)||0;e.height=n(b.height)||0},getViewport:function(){return e},__getEvents:function(){return p}}}});SpilGames("spilgames.import",{name:"PageTracker",deps:["EventTracker"],module:function(g){return{track:function(k,m){g.sendPageview(k||m)}}}});SpilGames("spilgames.import",{name:"RefTag",deps:["DOMEvent","Cache"],module:function(g,k){function m(a){return a&&"BODY"!==a.tagName?-1<a.className.indexOf("wdg_")?a:m(a.parentNode):!1}function e(a,b){return a&&b?a.getAttribute("name")?a:a===b?!1:e(a.parentNode,b):!1}function f(a,b){return b&&a&&a!==b?"LI"===a.tagName||"ARTICLE"===a.tagName?a:f(a.parentNode,b):!1}function p(a){var b=a.widget;a.namedElement&&(b+="-"+a.namedElement.getAttribute("name"));a.position&&(b+="-"+a.position);return b}function h(a){a=
a||window.event;var b=a.target||a.srcElement;if("object"===typeof b){a=m(b);var c;c=a?(c=/wdg_(\w+)/.exec(a.className))?c[1]:!1:!1;var g=e(b,a);if(b=f(b,g||a)){for(var h=1;b=b.previousSibling;)"LI"!==b.tagName&&"ARTICLE"!==b.tagName||h++;b=h}else b=!1;h={};a&&c&&(h={page:n,widget:c,namedElement:g||!1,position:b||!1},k.setItem({key:"reffererTag",value:p(h),expires:60}))}}var n,b=window,c=(b.performance||b.webkitPerformance||b.mozPerformance||b.msPerformance||{}).navigation;return{init:function(a){n=
a;g.add("body","click",h)},getReferrerTag:function(a){k.getItem({key:"reffererTag"},function(b){if(!b&&c&&c.type)switch(c.type){case c.TYPE_RELOAD:b="browser_reload";break;case c.TYPE_BACK_FORWARD:b="browser_back_forward"}a(b||!1);k.removeItem({key:"reffererTag"})})}}}});SpilGames("spilgames.import",{name:"TrackerData",deps:"Utils Cache SPAPI JSLib Portal FeatureDetector".split(" "),module:function(g,k,m,e,f,p){var h=this,n=e.get(h.ns+".module.tracker.environment"),b={},c=function(l){b.hasOwnProperty("Tracker.session")?l(b["Tracker.session"]):k.getItem({key:"Tracker.session"},function(b){!g.isEmpty(b)&&g.isNumber(b.sessionId)?l(b):a({sessionId:+new Date,pageInSession:0},l)})},a=function(a,d){d=d||g.emptyFn;var c={sessionId:a.sessionId,pageInSession:a.pageInSession};
k.setItem({key:"Tracker.session",value:c,expires:0},function(a){a||(b["Tracker.session"]=c);d(c)})},q=function(a){var d=Math.floor(1E15*Math.random());k.setItem({key:"Tracker.visitorId",value:d,expires:"never"},function(c){c||(b["Tracker.visitorId"]=d);a(d)})},x=function(a){b.hasOwnProperty("api.account.getToken")?a(b["api.account.getToken"]):SpilGames("api.account.getToken",{cache:!0},function(d){var c=d.auth.token.substr(8,16);b["api.account.getToken"]=c;d.isError||a(c)})},r=function(a,b){a=a||
"";b=b||function(a){return a};return function(){var c=a.substr(1),e,f,h=[];g.each(c.split("&"),function(a){f=a.split("=");if(0===a.length)return!1;e=b({name:f[0],value:2===f.length?f[1]:null});g.isObject(e)&&h.push(e)});return h}()},u=function(a){var b="campaignMedium campaignSource campaignName campaignElement adwordsAdgroupId adwordsKeyword".split(" "),c=["utm_medium","utm_source","utm_campaign","utm_content"],e=[];g.each(b,function(a){e.push(a.toLowerCase())});return r(a,function(a){var l=a.name.toLowerCase();
if(g.contains(e,l))return a.name=b[e.indexOf(l)],a;if(g.contains(c,l))return a.name=b[c.indexOf(l)],a})},v=function(){var a={},b=window.document,c=window.navigator,e=h.globals;a.location=e.hasOwnProperty("location")?e.location:b.URL;a.referrer=e.hasOwnProperty("referrer")?e.referrer:b.referrer;a.userAgent=e.hasOwnProperty("userAgent")?e.userAgent:c.userAgent;return a},t=function(){var a=function(a){var b={},d=window.document.createElement("a");d.href=a;g.each("href host hostname pathname port protocol search hash".split(" "),
function(a){b[a]=0<d[a].length?d[a]:null});return b},b=v();return{referrer:a(b.referrer),location:a(b.location),userAgent:b.userAgent,environment:n}};h.globals={};h.getVisitorId=function(a){b.hasOwnProperty("Tracker.visitorId")?a(b["Tracker.visitorId"]):k.getItem("Tracker.visitorId",function(b){b?a(b):q(a)})};return{getPageInfo:function(){var a=t(),b,c;b={pageType:f.get("pagetype"),pageTypeDetail:f.get("pagetypedetail"),portalVersion:f.get("portalversion"),requestId:f.get("requestid"),userAgent:a.userAgent,
referrerURL:a.referrer.href,testGroup:f.get("testgroup"),testVariant:f.get("testvariant"),theme:f.get("theme")};c=f.get("pageid");/^[0-9]+$/.test(c)&&(b.pageId=c);(c=f.get("devicetype"))&&(b.deviceType=c);g.each(u(a.location.search),function(a){b[a.name]=a.value});return b},getCommonData:function(b,d,e){e=!1;b.environment=n;x(function(f){b.token=f;h.getVisitorId(function(f){b.visitorId=f;c(function(c){e&&a(c);g.combine(b,c);d(b)})})})},incrementPageInSession:function(b){c(function(d){d.pageInSession+=
1;a(d,b)})},getPageInSession:function(a){c(function(b){a(b.pageInSession)})},getSessionId:function(a){c(function(b){a(b.sessionId)})},getVisitorId:h.getVisitorId,setGlobals:function(a){h.globals=a}}}});SpilGames("spilgames.import",{name:"Tracker",deps:["TrackerData","Utils","Net","JSON"],module:function(g,k,m,e){var f=this.getApi(),p=new Image,h,n=function(b){var c="",a;for(a in b)!k.isEmpty(b[a])&&k.has(b,a)&&(c=k.isObject(b[a])?c+n(b[a]):c+("&"+a+"="+encodeURIComponent(b[a])));2E3<c.length&&(c=c.substring(0,2E3));return c};f.get(this.ns+".module.tracker.endpoint")||f.set(this.ns+".module.tracker.endpoint","{$tracker_endpoint}");h=f.get(this.ns+".module.tracker.endpoint");return{getVisitorId:g.getVisitorId,
setNet:function(b){m=b},send:function(b,c){var a=b.settings;c=c||k.emptyFn;switch(a.sendFormat){case "autoselect":case "xhr":case "cors":case "jsonp":g.getCommonData(b.request,function(b){b=e.stringify(b);"autoselect"===a.sendFormat?m.set("transport",["cors","jsonp"]):m.set("transport",[a.sendFormat]);m.send({url:h,type:a.sendMethod,data:b},k.emptyFn);c(b)});break;case "gif":g.getCommonData(b.request,function(b){p.src="string"===a.dataFormat?h+"?"+n(b).substring(1):h+"?"+e.stringify(b);k.isFunction(c)&&
c(b)})}}}}});
