/* cached on: Thu, 03 Sep 2015 09:09:11 GMT */ 
_SG.extend=function(b,a){var d=_SG.Is.array(b)&&_SG.Is.array(a)?"array":_SG.Is.object(b)&&_SG.Is.object(a)?"object":false;if(d){for(var c in a){if(a.hasOwnProperty(c)){var e=a[c];if(c in b&&_SG.Is.object(b[c])&&_SG.Is.object(e)){b[c]=_SG.extend(b[c],e)}else{if(d=="array"){b.push(e)}else{b[c]=e}}}}}return b};_SG.append=_SG.extend;_SG.inherit=function(b,a){a.prototype=new b();return new a()};_SG.Is=new function(){var c=function(f){var e=["boolean","number","string","function","array","date","regexp","object"],a=false,d=e.length;while(d--){if(f=e[d]){a=true;break}}return a};var b=function(d,e){var a=false;if(e!==null&&_SG.Is.defined(e)){var f=Object.prototype.toString.call(e).match(/^\[object (.*)\]$/)[1].toLowerCase();a=(d==(c(f)?f:"object"))}return a};this.type=function(a,d){return(typeof d).match(new RegExp(a,"i"))!=null};this.defined=function(a){return typeof a!="undefined"};this.func=function(a){return b("function",a)};this.object=function(a){return b("object",a)};this.array=function(a){return b("array",a)};this.regexp=function(a){return b("regexp",a)};this.string=function(a){return b("string",a)};this.bool=function(a){return b("boolean",a)};this.nan=function(a){return a==null||!/\d/.test(a)||isNaN(a)};this.empty=function(e){var a=false;if(e===""||e===0||e===null||e===false||!this.defined(e)){a=true}else{if(_SG.Is.type("object",e)){a=true;for(var d in e){if(e.hasOwnProperty(d)){a=false;break}}}}return a}};(function(b){var f=b._SG,a=b.location,c=b.printStackTrace||null,e=Array.prototype.slice,d={log:function(){f.Events.publish("spilgames.debug.log",e.call(arguments))},error:function(){f.Events.publish("spilgames.debug.error",e.call(arguments))},warn:function(){f.Events.publish("spilgames.debug.warn",e.call(arguments))},debug:function(){f.Events.publish("spilgames.debug.debug",e.call(arguments))},info:function(){f.Events.publish("spilgames.debug.info",e.call(arguments))},assert:function(){f.Events.publish("spilgames.debug.assert",e.call(arguments))},trace:function(){f.Events.publish("spilgames.debug.trace",e.call(arguments))}};d.report=function(k){var n=k.onsuccess||f.Errors.nocallback,j=k.onfailure||f.Errors.nocallback,p=k.message||null,i=k.extra||null,h=k.level||3,o=k.line||null,m=k.filename||"spilgames.api.js",l=k.page||a.pathname,g="/lg/pb/1/";if(f.Is.type("object",p)){p=f.JSON.stringify(p)}if(p!==null){p=p.substr(0,2048)}if(f.Is.type("object",i)){i=f.JSON.stringify(i)}if(i!==null){i=i.substr(0,2048)}g+=f.Settings.get("portal.channel_id")+"/";g+=f.Settings.get("portal.site_id")+"/";g+=k.method||"report";f.Net.post({url:g,hdrs:{reportlevel:h,reportline:o,reportfilename:m,reportmessage:p,reportpage:l,reportextra:i},report:false,onsuccess:n,onfailure:j})};d.printStackTrace=function(h){if(f.Is.defined(h)){d.log(h)}if(c){try{throw""}catch(g){f.Head.include("plugin.stacktrace",function(){d.log(c({e:g}))})}}else{d.log(c())}};f.Debug=d}(window));_SG.Errors=new function(){var b=0,a=5;this.init=function(){if(_SG.Settings.get("errors.report")===true){window.onerror=function(e,d,c){_SG.Errors.report({level:1,message:e,filename:d,line:c,method:"error"})}}};this.nocallback=function(){};this.nosuccess=function(c){var d="Please implement the onsuccess handler.";_SG.Errors.create({code:501,data:d})};this.nofailure=function(c){SpilGames.Debug.error(c)};this.create=function(c){_SG.Events.publish("error.created",{errorcode:c.code||500,message:c.data||null,extra:c.extra||null});c.report=(_SG.Is.bool(c.report))?c.report:true;if(c.code==204){c.report=false}if(c.report!==false&&_SG.Settings.get("errors.report")===true){var d=(_SG.Is.type("object",c.data))?_SG.JSON.stringify(c.data):c.data;this.report({message:"["+c.code+"] "+d,extra:c.extra||null,method:"error"})}return{error:"An error has occurred"}};this.report=function(c){if(b++>=a){return false}_SG.Debug.report(c);return true}};_SG.Queue=new function(){this.push=function(a){var c=a[0].split("."),b=a[2];switch(c.length){case 1:if(c[0]=="SpilGames"){SpilGames.apply(SpilGames,b)}break;case 2:SpilGames[c[1]].apply(SpilGames,b);break;case 3:SpilGames[c[1]][c[2]].apply(SpilGames,b);break}};this.process=function(b,c,a){try{b.apply(c,a)}catch(d){try{b.apply(c,a)}catch(d){}throw SpilGames.Errors.create({data:"SG.Queue: call failed",extra:{method:b,scope:c,args:a}})}}};_SG.StateQueue=function(){var d="idle";var b="busy";var c=d;var a=[];this.isBusy=function(){return c==b};this.setBusy=function(e){c=e?b:d};this.push=function(){for(var e=0;e<arguments.length;e++){a.push(arguments[e])}};this.shift=function(){return a.shift()};this.isEmpty=function(){return a.length==0}};_SG.Cookies=new function(){var a=function(g,f,c){g=(!_SG.Is.regexp(g))?new RegExp(g):g;c=(_SG.Is.defined(c))?c:true;var e=document.cookie.split(";");for(var d=0;d<e.length;d++){var b=e[d].replace(/^\s+/,"");if(b.match(g)){f.call(this,b);if(c){break}}}};this.available=function(){var b=(navigator.cookieEnabled)?true:false;if(!_SG.Is.defined(navigator.cookieEnabled)&&!b){document.cookie="enabled";b=(document.cookie.indexOf("enabled")!=-1)}return b};this.set=function(e,d,b){var f="";if(_SG.Is.defined(b)&&b!=0){var c=new Date();c.setTime(c.getTime()+(b*1000));f="; expires="+c.toGMTString()}document.cookie=e+"="+d+f+"; path=/"};this.get=function(b){var c=null,d=new RegExp("^\\s*"+b+"=","");a(d,function(e){c=e.replace(d,"")});return(c&&c!="")?c:null};this.remove=function(b){_SG.Cookies.set(b,"",-1)};this.clear=function(b){b=_SG.Is.defined(b)?b:"";var c=new RegExp("^[\\s.]*"+b+".*=","");a(c,function(d){_SG.Cookies.remove(d.match(c)[0].replace(/=$/,""))},false)}};_SG.Cache=new function(){_SG.Settings.setDefault("cache.storageType","web");_SG.Settings.setDefault("cache.keyPrefix","SGC.");var e=_SG.Settings.get("cache.keyPrefix");this.TRANSIENT="TRANSIENT";var a=new _SG.StateQueue();var g=null;var f=function(i){var j=g;if(i==_SG.Cache.TRANSIENT){j=b}else{if(!g){switch(_SG.Settings.get("cache.storageType")){case"web":g=h.available()?h:null;break;case"cookie":g=d.available()?d:null;break;case"js":g=b;break}if(!g){if(h.available()){g=h}else{if(d.available()){g=d}else{g=b}}}j=g}}return j};var h=new function(){var j=null,i=null;this.available=function(){var m=(j!=null&&i!=null);if(!m){try{j=window.localStorage;i=window.sessionStorage;m=(j!=null&&i!=null);var n=e+"_availabilityTest";var k="";while(k.length<256){k+="X"}j.setItem(n,k);j.removeItem(n);i.setItem(n,k);i.removeItem(n)}catch(l){}}return m};this.getItem=function(k){var l=(j.getItem(k)===null)?i.getItem(k):j.getItem(k);return(l!==null&&l!=""?JSON.parse(l):null)};this.setItem=function(n,m,l){var p=(l!=0)?j:i;var k=(l!=0)?i:j;try{p.setItem(n,JSON.stringify(m));if(_SG.Is.func(k.remove)){k.remove(n)}}catch(o){_SG.Errors.create({code:500,data:o})}};this.remove=function(k){j.removeItem(k);i.removeItem(k)};this.clear=function(){var k=function(n){var o=new RegExp("^"+e);for(var m=n.length;m--;){var l=n.key(m);if(l.match(o)){n.removeItem(l)}}};k(j);k(i)}};var d=new function(){this.available=function(){return _SG.Cookies.available()};this.getItem=function(i){var j=_SG.Cookies.get(i);if(j!==null){j=_SG.JSON.parse(decodeURIComponent(j))}return j};this.setItem=function(k,j,i){_SG.Cookies.set(k,encodeURIComponent(_SG.JSON.stringify(j)),i)};this.remove=function(i){_SG.Cookies.remove(i)};this.clear=function(){_SG.Cookies.clear(e)}};var b=new function(){var i={};this.getItem=function(j){var k=i[j];return(_SG.Is.defined(k))?_SG.JSON.parse(k):null};this.setItem=function(l,k,j){i[l]=_SG.JSON.stringify(k)};this.remove=function(j){if(j in i){delete i[j]}};this.clear=function(){i={}}};var c=function(i){if(!_SG.Is.string(i)||i==""){_SG.Errors.create({code:500,data:"Cache: key is not a valid string"})}};this.get=function(j,i){c(j);var k=f(i).getItem(e+j);return(k)&&(k.expiration==0||(new Date()).getTime()<k.expiration)?k.value:undefined};this.set=function(l,k,i,j){c(l);i=(_SG.Is.defined(i))?i:0;f(j).setItem(e+l,{value:k,expiration:((i!=0)?(new Date().getTime()+(i*1000)):0)},i)};this.remove=function(j,i){c(j);f().remove(e+j)};this.clear=function(){if(h.available()){h.clear()}if(d.available()){d.clear()}b.clear();g=null;SpilGames.Events.publish("cache.cleared")};this.fetch=function(i,p,l,m){p=p||{};var q=p.onsuccess||_SG.Errors.nosuccess;var j=p.onfailure||_SG.Errors.nofailure;var k=l||_SG.Errors.nocallback;var n=function(){a.setBusy(false);if(!a.isEmpty()){_SG.Cache.fetch.apply(_SG.Cache,Array.prototype.slice.call(a.shift()))}};var o=p.bustCache?undefined:_SG.Cache.get(i);if(_SG.Is.defined(o)){q.call(this,o);if(!a.isBusy()){n()}}else{if(a.isBusy()){a.push(arguments)}else{p.onsuccess=function(r){_SG.Cache.set(i,r,m);q.call(this,r);n()};p.onfailure=function(r){j.call(this,r);n()};a.setBusy(true);k.call(this)}}}};_SG.Deprecation=new function(){this.init=function(){this.moved("_SG.Highscores.showScoreboard","_SG.Portal.showScoreboard");this.moved("_SG.Net.gotoPage","_SG.Portal.gotoPage");this.moved("_SG.Users.getLocale","_SG.Portal.getLocale");this.renamed("currentGameInfo","portal.game_info","setting");this.renamed("locale","portal.locale","setting");this.renamed("net.gotopage.result","gotopage.result","event");this.renamed("net.gotopage.request","gotopage.request","event");this.renamed("highscores.showscoreboard","scoreboard.request","event");this.renamed("invitefriends.send","invitefriends.result","event");this.renamed("activities.post","activities.result","event");this.renamed("message.send","message.result","event")};this.moved=function(_oldFunc,_newFunc){var override=function(){_SG.Debug.warn("Deprecated, moved function "+_oldFunc+" used. Use "+_newFunc+" instead.");eval(_newFunc).apply(this,arguments)};eval(_oldFunc+"="+override.toString())};this.deleted=function(_func){var override=function(){_SG.Errors.create({data:"Deprecation: deleted function used",extra:{func:_func}});_SG.Debug.error("Deprecated, deleted function "+_func+" used.")};eval(_func+"="+override.toString())};var renamed=[];this.renamed=function(_old,_replacement,_context){renamed.push({old:_old.toLowerCase(),rep:_replacement.toLowerCase(),context:_context})};this.checkRenamed=function(_string){_string=_string.toLowerCase();for(var i=0;i<renamed.length;i++){var obj=renamed[i];if(obj.old==_string){_SG.Debug.warn("Deprecated "+obj.context+" "+obj.old+" used. Use "+obj.rep+" instead.");return obj.rep}}return _string}};_SG.Events=new function(){var g={};var d=new _SG.StateQueue();var h=0;var b=function(j){var i=g[j];if(!_SG.Is.defined(i)){g[j]=i={subscribers:[],singleSubscribers:[]}}return i};var e=function(i,l,k,j){i.push({callback:l,scope:k,count:_SG.Is.defined(j)?j:h++})};var a=function(j,l){for(var k=0;k<j.length;k++){if(j[k].callback==l){j.splice(k,1);return true}}return false};var f=function(l,j){for(var k=0;k<l.length;k++){var m=l[k];e(j,m.callback,m.scope,m.count)}};this.subscribeOnce=function(k,l){k=_SG.Deprecation.checkRenamed(k);if(!/^spilgames\.debug\./.test(k)){_SG.Debug.info("events.subscribeOnce: "+k)}var j=b(k);var i=this;e(j.singleSubscribers,l,i)};this.subscribe=function(k,l){k=_SG.Deprecation.checkRenamed(k);if(!/^spilgames\.debug\./.test(k)){_SG.Debug.info("events.subscribe: "+k)}var j=b(k);var i=this;e(j.subscribers,l,i)};this.unsubscribe=function(j,k){j=_SG.Deprecation.checkRenamed(j);_SG.Debug.info("events.unsubscribe: "+j);var i=b(j);if(!a(i.singleSubscribers,k)){a(i.subscribers,k)}};var c=function(l,i){var k=false;var j=_SG.Is.defined(l)?l:true;this.isStoppable=function(){return j};this.stop=function(){if(j){_SG.Debug.info(i+".propagation.stop");k=true}};this.isStopped=function(){return k}};this.publish=function(r,n,s,t,o){r=_SG.Deprecation.checkRenamed(r);t=_SG.Is.defined(t)?t:false;var k=o;if(!_SG.Is.defined(k)){var l=b(r);k=[];f(l.subscribers,k);f(l.singleSubscribers,k);l.singleSubscribers=[]}if(d.isBusy()){d.push({event:r,data:n,callback:s,stoppable:t,subscribers:k})}else{d.setBusy(true);if(!/^spilgames\.debug\./.test(r)){_SG.Debug.info(["events.publish: "+r,n])}k.sort(function(i,u){return i.count-u.count});var m=new c(t,r);for(var q=0;q<k.length;q++){var j=k[q];j.callback.call(j.scope,n,m);if(m.isStopped()){break}}if(s){s.call(this,m)}d.setBusy(false);if(!d.isEmpty()){var p=d.shift();SpilGames.Events.publish(p.event,p.data,p.callback,p.stoppable,p.subscribers)}}}};_SG.Transport={Ajax:function(b,a,d){var h;var f=[function(){return new XMLHttpRequest()},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];for(var c=0;c<f.length;c++){try{h=f[c]()}catch(g){continue}break}h.onreadystatechange=function(){d.call(h,{status:h.readyState});if(h.readyState==4){if(h.status==200){b.call(h,h.responseText)}else{if(h.status>0){a.call(h,_SG.Errors.create({code:h.status,data:h.responseText}))}}}};this.open=function(i,j,k,e){h.open(i,j,k)};this.setHeaders=function(i){for(var e in i){h.setRequestHeader(e,i[e])}};this.send=function(e){h.send(e)};this.abort=function(){h.abort()};this.getValidMethod=function(e){return e};this.getTimeoutMessage=function(e){return"[AJAX] "+e+", readystate: "+h.readyState}},Opensocial:function(b,a,d){var c="";var e={};this.aborted=false;this.open=function(h,i,j,g,f){if(!gadgets){throw"SG.Transport.Opensocial: gadgets code not loaded"}c=i;var k=gadgets.io;e[k.RequestParameters.METHOD]=(h=="get")?k.MethodType.GET:k.MethodType.POST;e[k.RequestParameters.CONTENT_TYPE]=(g=="json")?k.ContentType.JSON:k.ContentType.TEXT;e[k.RequestParameters.AUTHORIZATION]=f.authorization||k.AuthorizationType.NONE};this.setHeaders=function(f){e[gadgets.io.RequestParameters.HEADERS]=f};this.send=function(f){if(f){e[gadgets.io.RequestParameters.POST_DATA]=f}var h=this;var g=_SG.extend({},gadgets);g.io.makeRequest(c,function(i){if(_SG.Is.empty(i.errors)){if(!h.aborted){b.call(this,i.data)}}else{a.call(this,_SG.Errors.create({code:500,data:i.errors}))}},e)};this.abort=function(){this.aborted=true};this.getValidMethod=function(f){return f};this.getTimeoutMessage=function(f){return"[OpenSocial] "+f}},JSONP:function(b,a,f){var e=_SG.Transport.JSONP;var h=e.count=++e.count||0;var d="jsonp_"+h;var c="";var g=null;this.open=function(j,k,l,i){c=k};this.setHeaders=function(i){};this.send=function(i){var j=this;window[d]=function(){b.apply(b,arguments);j.abort()};g=document.createElement("script");g.src=c+((/\?/.test(c))?"&":"?")+"callback="+d;document.body.appendChild(g)};this.abort=function(){if(g){document.body.removeChild(g)}window[d]=null};this.getValidMethod=function(i){return"get"};this.getTimeoutMessage=function(i){return"[JSONP] "+i}}};_SG.Net=new function(){_SG.Settings.setDefault("net.transport",_SG.Transport.Ajax);var getTransport=function(_params,onsuccess,onfailure,onstatechange){var transport=_params.transport||SpilGames.Settings.get("net.transport");if(_SG.Is.string(transport)){try{transport=eval(transport)}catch(err){}}if(_SG.Is.func(transport)){return new transport(onsuccess,onfailure,onstatechange)}return new _SG.Transport.Ajax(onsuccess,onfailure,onstatechange)};var handle=function(_params,_newCallback){_params=_params||{};var _url=_params.url||"/";var _data=_params.data||{};var _method=_params.method||"GET";var _async=_params.async||true;var _hdrs=_params.hdrs||{};var _type=_params.type||"text";var _timeout=_params.timeout||5;var onsuccess=_params.onsuccess||_newCallback||_SG.Errors.nosuccess;var onfailure=_params.onfailure||_SG.Errors.nofailure;var onstatechange=_params.onstatechange||_SG.Errors.nocallback;var success=function(data){clearTimeout(reqTimer);switch(_type.toLowerCase()){case"json":try{if(_SG.Is.string(data)){data=_SG.JSON.parse(data)}}catch(e){onfailure.call(this,_SG.Errors.create({code:500,data:"Could not parse JSON data.",extra:data}));return}break}onsuccess.call(this,data)};var failure=function(data){clearTimeout(reqTimer);onfailure.call(this,data)};var _paramsString="";if(_SG.Is.type("object",_data)){for(var x in _data){if(_paramsString!==""){_paramsString+="&"}_paramsString+=encodeURIComponent(x)+"=";if(_SG.Is.type("object",_data[x])){_paramsString+=encodeURIComponent(_SG.JSON.stringify(_data[x]))}else{_paramsString+=encodeURIComponent(_data[x])}}}else{_paramsString=encodeURIComponent(_data)}if(_paramsString===""){_paramsString=null}var transport=getTransport(_params,success,failure,onstatechange);_method=transport.getValidMethod(_method);var _sendData=null;if(_method.toLowerCase()=="post"){_sendData=_paramsString}else{if(_paramsString!==null){_url+=(/\?/.test(_url))?"&":"?";_url+=_paramsString}}transport.open(_method,_url,_async,_type,_params);transport.setHeaders(_hdrs);transport.send(_sendData);var reqTimer=setTimeout(function(){var error=_SG.Errors.create({code:408,data:transport.getTimeoutMessage("Timeout occoured while processing url: "+_url)});transport.abort();onfailure.call(this,error)},(_timeout*1000))};this.get=function(_params,_callback){_params=_params||{};_params.method="GET";handle(_params,_callback)};this.post=function(_params,_callback){_params=_params||{};_params.method="POST";var _hdrs=_params.hdrs||{};_hdrs["Content-Type"]=_hdrs["Content-Type"]||"application/x-www-form-urlencoded";_params.hdrs=_hdrs;handle(_params,_callback)}};_SG.SocialGateway=function(){var sendRequest=function(_method,_params){_params=_params||{};var prefix=SpilGames.Settings.get("socialgateway.domain")||"";var _url=prefix+"/sg/pb/1/";_url+=_SG.Settings.get("portal.channel_id")+"/";_url+=_SG.Settings.get("portal.site_id")+"/";_url+=_method;_params.url=_url;_params.data=_params.data||{};_params.data.hash=_params.data.hash||_SG.Auth.getAuthData().hash||null;_params.type=_params.type||"json";_params.data={params:_params.data};var onsuccess=_params.onsuccess;_params.onsuccess=function(resp){var scope={response:resp.data};var code=resp.code||null;if(code===null){_params.onfailure.call(scope);return}if(code=="200"){onsuccess.call(this,resp.data);return}_params.onfailure.call(scope)};_SG.Net.post(_params)};this.sendRequest=sendRequest;var getGameID=function(_params){var gameinfo=_SG.Settings.get("portal.game_info")||{};return _params.gameid||gameinfo.id||null};this.getGameID=getGameID;this.getUsers=function(_params){_SG.Auth.authenticate({onsuccess:function(data){_params=_SG.extend(_params,{data:{pagesize:_params.pagesize||null,pagenr:_params.pagenr||null}});var onsuccess=_params.onsuccess||_SG.Errors.nosuccess;_params.onsuccess=function(resp){for(var i=0;i<resp.users.length;i++){var user=resp.users[i];user.is_guest=_SG.Is.defined(user.is_guest)?user.is_guest:!user.is_app_user}onsuccess.call(this,resp)};sendRequest("getUsers",_params)},onfailure:function(error){var onfailure=_params.onfailure||_SG.Errors.nofailure;onfailure.call(this,error)}})};this.get=function(_params){var _data={users:_params.users};this.getUsers(_SG.extend({data:_data},_params))};this.getCurrentUser=function(_params){var onsuccess=_params.onsuccess;_params.onsuccess=function(resp){var data=resp.users[0];onsuccess.call(this,data)};var _data={userid:"current"};this.getUsers(_SG.extend({data:_data},_params))};this.getFriends=function(_params){var _data={userid:"current",users:"@friends"};this.getUsers(_SG.extend({data:_data},_params))};this.getAvatar=function(_params){var onsuccess=_params.onsuccess,_data={users:_params.users};_params.onsuccess=function(data){var newData={};for(var i=0,ln=data.length;i<ln;++i){newData[data[i].uid]=data[i]}onsuccess(newData)};sendRequest("getAvatar",_SG.extend({data:_data},_params))};this.insertScore=function(_params){var onsuccess=_params.onsuccess||_SG.Errors.nosuccess;var onfailure=_params.onfailure||_SG.Errors.nofailure;if(_SG.Auth.getAuthState()=="NOT_AUTHENTICATED"){onsuccess.call(this,_params.score);return}var gameinfo=_SG.Settings.get("portal.game_info")||{};var gameid=_params.gameid||gameinfo.id||null;if(gameid===null){onfailure.call(this,_SG.Errors.create({code:500,data:"No game id set."}));return}_SG.Users.getCurrentUser({onsuccess:function(_user){var userid=_user.uid;if(!_params.force){var lastInsert=_SG.Cache.get("_SG.Highscores.lastInsert",_SG.Cache.TRANSIENT);if(_SG.Is.defined(lastInsert)){if(lastInsert.userid==userid&&lastInsert.gameid==gameid&&_params.score<lastInsert.score){onsuccess.call(this,_params.score);return}}}sendRequest("hst",{onsuccess:function(_result){_SG.Head.include("plugin.encryption",function(){var s=_params.score,t=_result.time,n=_result.n,k=_SG.Encryption.rot13.encode(_result.k),q="s="+s+"&t="+t+"&n="+n,h=_SG.Encryption.MD5(q+"&k="+k),u=_SG.Encryption.rot13.encode(_SG.Encryption.Base64.encode(q+"&h="+h));sendRequest("hsi",{data:{s:u,itemid:gameid,username:userid,returnlist:0},onsuccess:function(resp){resp.errorcode=resp.errorcode||0;if(resp.errorcode==0){_SG.Cache.set("_SG.Highscores.lastInsert",{userid:userid,gameid:gameid,score:_params.score},0,_SG.Cache.TRANSIENT);onsuccess.call(this,_params.score)}else{onfailure.call(this,_SG.Errors.create({code:resp.errorcode,data:resp.message}))}},onfailure:onfailure})})},onfailure:onfailure})},onfailure:onfailure})};this.getPlays=function(_params){_params.auth=(_SG.Is.bool(_params.auth))?_params.auth:true;_params.method=_params.method||"myScores";_params.key=_params.key||"scores";var onsuccess=_params.onsuccess||_SG.Errors.nosuccess;var onfailure=_params.onfailure||_SG.Errors.nocallback;var fetch=function(_method,_data){_data=_SG.extend({pagenr:1,pagesize:10,outputtype:"json"},_data);sendRequest(_method,{data:_data,onsuccess:function(data){onsuccess.call(this,preparePlayData(data))},onfailure:onfailure})};var preparePlayData=function(_resp){var data=_resp||{},_data=[],_games={},_users={},i;data.games=data.games||{};for(i=0;i<data.games.length;i++){_games[data.games[i].gameid]=data.games[i]}data.users=data.users||{};for(i=0;i<data.users.length;i++){_users[data.users[i].uid]=data.users[i]}var list=data[_params.key]||[];var _row,_gameid;for(i=0;i<list.length;i++){_row=list[i];_gameid=_row.itemid||_row.gameid;_row.game=_games[_gameid]||{gameid:_gameid};_row.user=_users[_row.userid]||{uid:_row.userid,name:_row.userid};delete _row[_gameid];delete _row.userid;delete _row.itemid;delete _row.gameid;_data.push(_row)}var _return={};_return[_params.key]=_data;return _return};if(_params.auth===true){_SG.Users.getCurrentUser({onsuccess:function(_user){_params.data.userid=_user.uid;fetch.call(this,_params.method,_params.data)},onfailure:onfailure})}else{fetch.call(this,_params.method,_params.data)}};this.getMyScores=function(_params){var data=_SG.extend({users:["current"]},_params.data||{});var params={method:"myScores",data:data};this.getPlays(_SG.extend(params,_params))};this.getFriendScores=function(_params){var data=_SG.extend({users:"@friends"},_params.data||{});var params={method:"friendScores",data:data};this.getPlays(_SG.extend(params,_params))};this.getGameScores=function(_params){var data=_SG.extend({gameid:getGameID(_params)},_params.data||{});var params={method:"gameScores",auth:false,data:data};this.getPlays(_SG.extend(params,_params))};this.getGameFriendScores=function(_params){var data=_SG.extend({gameid:getGameID(_params),user:"@friends_and_user",userid:"current"},_params.data||{});var params={method:"friendScores",data:data};this.getPlays(_SG.extend(params,_params))};this.getFriendRecentPlayScores=function(_params){var params={method:"friendPlayedGamesScores",data:{users:"@friends_and_user",userid:"current"}};this.getPlays(_SG.extend(params,_params))};this.getMyPlays=function(_params){var params={method:"myPlays",key:"listplayed",data:{users:["current"]}};this.getPlays(_SG.extend(params,_params))};this.getFriendPlays=function(_params){var params={method:"friendPlays",key:"listplayed",data:{users:"@friends"}};this.getPlays(_SG.extend(params,_params))};this.getActivityFeed=function(_params){var onsuccess=_params.onsuccess||_SG.Errors.nosuccess;var onfailure=_params.onfailure||_SG.Errors.nofailure;_SG.Users.getCurrentUser({onsuccess:function(_userdata){var _data=_SG.extend({pagenr:_params.pagenr||1,pagesize:_params.pagesize||10,type:1,outputtype:"json"},_params.data);sendRequest("activityFeed",{data:_data,onsuccess:onsuccess,onfailure:onfailure})},onfailure:onfailure})};this.activityPost=function(_params){var onsuccess=_params.onsuccess||_SG.Errors.nosuccess;var onfailure=_params.onfailure||_SG.Errors.nofailure;var gameinfo=_SG.Settings.get("portal.game_info")||{};var gameid=_params.gameid||gameinfo.id||0;_SG.Users.getCurrentUser({onsuccess:function(_user){var _data={};_data.username=_user.name||null;_data.itemname=_params.itemname||_data.username;_data.comment=_params.comment||null;_data.image_url=_params.image||gameinfo.activity_img||_user.pic_square||"";_data.itemtype=_params.itemtype||1;_data.itemid=_params.itemid||gameid;sendRequest("activityPost",{data:_data,onsuccess:function(){onsuccess.call(this,true)},onfailure:onfailure})},onfailure:onfailure})};this.handle=function(_method,_params){_params=_params||{};var _func=eval("this."+_method);if(_SG.Is.func(_func)){_func.call(this,_params)}else{sendRequest.call(this,_method,_params)}}};_SG.Backend=new function(){this.get=function(_backend,_params){var backend=_backend||_SG.Settings.get("backend.default");if(_SG.Is.string(backend)){try{backend=eval(backend)}catch(err){}}if(_SG.Is.func(backend)){return new backend(_params)}return new _SG.SocialGateway(_params)}};_SG.Auth=new function(){_SG.Settings.setDefault("auth.default_ttl",365*24*3600);_SG.Settings.setDefault("auth.guest_allowed",false);var b="NOT_AUTHENTICATED";var c="AUTHENTICATING";var a="AUTHENTICATED";var f=b;var g={};var d=[];var e=function(){return _SG.Backend.get(_SG.Settings.get("auth.backend"))};this.init=function(){var i=_SG.Cache.get("SpilGames.Auth.authdata");if(_SG.Is.defined(i)&&i.uid==_SG.Settings.get("auth.uid")){_SG.Events.publish("auth.login",i)}};this.authenticate=function(j){j=j||{};if(f==a){var i=j.onsuccess||_SG.Errors.nocallback;i.call(this,g)}else{d.push(j);if(f==b){f=c;if(_SG.Settings.get("auth.guest_allowed")===true){_SG.Auth.login()}else{_SG.Events.publish("auth.request",j)}}}};this.login=function(i){i=i||{};i.type=i.type||"json";if(!_SG.Is.defined(i.onsuccess)){i.onsuccess=function(j){_SG.Events.publish("auth.login",{status:"success",hash:j,ttl:i.ttl})}}if(!_SG.Is.defined(i.onfailure)){i.onfailure=function(j){_SG.Events.publish("auth.login",{status:"failed"})}}e().handle("login",i)};this.getAppToken=function(i){var i=_SG.Is.func(i)?{onsuccess:i,onfailure:i}:i;handleCallback=(function(k){var j=function(l){if(k.onsuccess){k.onsuccess.call(this,l)}};j.error=function(l){if(k.onfailure){k.onfailure.call(this,l)}};return j}(i));if(!g||!g.hash){e().handle("login",{onsuccess:handleCallback,onfailure:handleCallback.error,type:"json"})}else{handleCallback(g.hash)}};this.linkGuestAccount=function(i){e().handle("linkGuestAccount",i)};this.getAuthData=function(){return g||{}};this.getAuthState=function(){return f};var h=function(i){var k;while(d.length>0){var j=d.shift();if(i=="success"){k=j.onsuccess||_SG.Errors.nocallback;k.call(this,g)}else{k=j.onfailure||_SG.Errors.nocallback;k.call(this,_SG.Errors.create({code:401,msg:"failed to login"}))}}};_SG.Events.subscribe("auth.logout",function(){f=b;g={};_SG.Cache.clear()});_SG.Events.subscribe("auth.login",function(k){switch(k.status){case"success":if(!_SG.Is.defined(k.hash)){throw"auth.login: _authdata has no hash"}var j=_SG.Cache.get("SpilGames.Auth.authdata");if(!_SG.Is.defined(j)||j.hash!=k.hash){_SG.Cache.clear()}k.uid=_SG.Settings.get("auth.uid");var i=_SG.Is.defined(k.ttl)?k.ttl:_SG.Settings.get("auth.default_ttl");_SG.Cache.set("SpilGames.Auth.authdata",k,i);g=k;f=a;break;case"failed":f=b;break;default:throw"auth.login failed due to invalid status"}h(k.status)})};_SG.Users=new function(){var a=function(){return _SG.Backend.get(_SG.Settings.get("users.backend"))};this.get=function(b){a().handle("get",b)};this.getCurrentUser=function(b){_SG.Cache.fetch("Users.getCurrentUser",b,function(){a().handle("getCurrentUser",b)})};this.getFriends=function(b){var c="Users.getFriends";c+="."+b.pagesize;c+="."+b.pagenr;_SG.Cache.fetch(c,b,function(){a().handle("getFriends",b)})};this.getAvatar=function(b){a().handle("getAvatar",b)}};_SG.Highscores=new function(){var a=function(){return _SG.Backend.get(_SG.Settings.get("highscores.backend"))};this.insert=function(c){var b=c.onsuccess||_SG.Errors.nocallback;c.onsuccess=function(d){_SG.Events.publish("highscore.inserted",d);b.call(this,d)};a().handle("insertScore",c)};this.getFriendScores=function(b){a().handle("getFriendScores",b)};this.getMyScores=function(b){a().handle("getMyScores",b)};this.getGameScores=function(b){a().handle("getGameScores",b)};this.getGameFriendScores=function(b){a().handle("getGameFriendScores",b)};this.getFriendRecentPlayScores=function(b){a().handle("getFriendRecentPlayScores",b)}};_SG.Gameplay=new function(){var a=function(){return _SG.Backend.get(_SG.Settings.get("gameplay.backend"))};this.insert=function(e){var c=e.onsuccess||_SG.Errors.nosuccess;var b=e.onfailure||_SG.Errors.nofailure;var d=_SG.Settings.get("portal.game_info")||{};var f=e.gameid||d.id||null;if(f===null){b.call(this,_SG.Errors.create({code:500,data:"No game id set."}));return}_SG.Users.getCurrentUser({onsuccess:function(g){var h="/hb/pb/1/insert/";h+=_SG.Settings.get("portal.channel_id")+"/";h+=_SG.Settings.get("portal.site_id")+"/1/";h+=f;SpilGames.Net.post({url:h,data:{userid:g.uid,outputtype:"json"},onsuccess:function(){c.call(this,true)},onfailure:b})},onfailure:b})};this.getMyPlays=function(b){a().handle("getMyPlays",b)};this.getFriendPlays=function(b){a().handle("getFriendPlays",b)}};_SG.Activities=new function(){var a=function(){return _SG.Backend.get(_SG.Settings.get("activities.backend"))};this.getActivityFeed=function(b){a().handle("getActivityFeed",b)};this.post=function(b){a().handle("activityPost",b)}};_SG.Portal=new function(){var b=function(g,f){f=f||{};var e=f.onsuccess||_SG.Errors.nocallback;SpilGames.Events.publish(g,f);e.call(this,true)},a=function(f,e,g){SpilGames("tracker.event.track",{eventCategory:f,eventAction:e,eventValue:g,properties:{pageId:(_SG.Settings.get("portal.game_info"))?_SG.Settings.get("portal.game_info").id:null}})},c=function(){return Date.parse(new Date())},d=c();this.getInformation=function(f){f=f||{};var e=f.onsuccess||_SG.Errors.nocallback;var g={channel_id:_SG.Settings.get("portal.channel_id"),site_id:_SG.Settings.get("portal.site_id"),gameinfo:_SG.Settings.get("portal.game_info")};e.call(this,g)};this.adjustHeight=function(e){b("portal.adjustheight",e)};this.requestGameBreak=function(e){var f=this,g=e||{};SpilGames(["Utils","JSLib"],function(j,h){f.onGameBreakStart=j.once(g.onstart||function(){});f.onGameBreakEnd=j.once(g.onend||function(){});if(!f.enableGameBreakListener){f.enableGameBreakListener=true;h.subscribe("ad.request.accepted",function(){a("midrollAds","requested",((c()-d)/1000));SpilGames("game.ad.accepted",true);a("midrollAds","start",((c()-d)/1000));f.onGameBreakStart()})}function i(){a("midrollAds","end",((c()-d)/1000));f.onGameBreakEnd();h.unsubscribe("ad.complete",i)}h.subscribe("ad.complete",i);SpilGames("game.ad.request")})};this.showInviteFriends=function(e){b("invitefriends.request",e)};this.showScoreboard=function(e){b("scoreboard.request",e)};this.forceAuthentication=function(e){b("portal.forceauthentication",e)};this.gotoPage=function(e){e=e||{};var f=e.page;if(!_SG.Is.defined(f)){throw"SpilGames.Portal.gotoPage: no page specified"}SpilGames.Events.subscribeOnce("gotopage.result",function(i){var h=e.onsuccess||null;var g=e.onfailure||null;var j=i.result;if(j&&h){h.call(this,{page:f})}else{if(!j&&g){g.call(this,{page:f})}}});SpilGames.Events.publish("gotopage.request",e)};this.getLocale=function(e){var e=_SG.Is.func(e)?{onsuccess:e,onfailure:e}:e;_SG.Net.get({url:"/lc/pb/1/country?outputtype=json",onsuccess:function(f){f=f.locatar;f.toString=function(){return f.country_code};e.onsuccess.call(this,f)},onfailure:e.onfailure||function(){},type:"json"})}};_SG.Head.ready(function(){var a=function(){var c;for(c in _SG){if(_SG.hasOwnProperty(c)){SpilGames[c]=_SG[c]}}_SG=SpilGames;for(c in _SG){if(_SG.hasOwnProperty(c)){c=_SG[c];if(c.init){c.init.call(c)}}}for(c in _SG){if(_SG.hasOwnProperty(c)){c=_SG[c];if(c.postInit){c.postInit.call(c)}}}for(var b=0;b<_spque.length;b++){_SG.Queue.push(_spque[b])}var d=["portal.channel_id","portal.site_id"];for(b=0;b<d.length;b++){if(_SG.Settings.get(d[b])===null){_SG.Debug.error("Please configure "+d[b]);return false}}_SG.Events.publish("api.initialized")};if(!_SG.Is.defined(window.JSON)){_SG.Head.include("plugin.json",function(){window.JSON=new JSON;_SG.JSON=window.JSON;a.call(this)})}else{_SG.JSON=window.JSON;a.call(this)}});